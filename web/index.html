<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>RAG SaaS</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f9f9f9;
    }

    h1 {
      margin-top: 0;
    }

    .forms-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.5rem;
    }

    section {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: 0 1.5px 6px rgba(15, 23, 42, 0.08);
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.75rem;
    }

    input,
    textarea {
      margin-top: 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #cbd5f5;
      border-radius: 0.5rem;
    }

    button {
      margin-top: 0.5rem;
      align-self: flex-start;
      padding: 0.6rem 1rem;
      border-radius: 0.5rem;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    #chat-result {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #f1f5f9;
      border-radius: 0.5rem;
      min-height: 1.5rem;
    }

    @media (max-width: 768px) {
      .forms-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <h1>RAG SaaS</h1>

  <div class="forms-grid">
    <section>
      <h2>Document Ingestion</h2>
      <form id="ingest-form" action="/ingest-file" method="post" enctype="multipart/form-data">
        <label>
          Workspace ID:
          <input type="text" name="workspace_id" required list="workspace-list" />
        </label>
        
        <label>
          Role:
          <input type="text" name="role" />
        </label>
        <label>
          File:
          <input type="file" name="file" required />
        </label>
        <button type="submit">Upload</button>
      </form>
      <div id="ingest-result"></div>
      <div id="ingest-error"></div>
    </section>

    <section>
      <h2>Chat</h2>
      <form id="chat-form" action="/chat" method="post">
        <label>
          Workspace ID:
          <input type="text" name="workspace_id" required list="workspace-list" />
        </label>
        
        <label>
          Question:
          <textarea name="question" rows="3" required></textarea>
        </label>
        <label>
          Role (optional):
          <input type="text" name="role" />
        </label>
        <button type="submit">Ask</button>
      </form>
      <div id="chat-result"></div>
      <div id="chat-error"></div>
    </section>

    <datalist id="workspace-list"></datalist>

  </div>

  <script>
    (function () {
      // === Chat form logic ===
      setupChat();
      // === Ingestion form logic ===
      setupIngest();
      loadWorkspaces();

  function loadWorkspaces() {
    fetch("https://rag-saas-rag-630957115938.me-west1.run.app/workspaces")
      .then((res) => res.json())
      .then((data) => {
        const datalist = document.getElementById("workspace-list");
        if (!datalist) return;

        datalist.innerHTML = "";
        const ids = Array.isArray(data.workspaces) ? data.workspaces : [];
        ids.forEach((id) => {
          const opt = document.createElement("option");
          opt.value = id;
          datalist.appendChild(opt);
        });
      })
      .catch(() => {
        // quietly ignore the error, just without autocomplete
      });
  }

      function setupChat() {
        const chatForm = document.querySelector('form[action="/chat"]');
        const resultEl = document.getElementById("chat-result");
        const chatError = document.getElementById("chat-error");

        if (!chatForm || !resultEl) return;

        chatForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          const formData = new FormData(chatForm);
          const workspace_id = (formData.get("workspace_id") || "").toString();
          const question = (formData.get("question") || "").toString();
          let role = formData.get("role");
          role = role && role.toString().trim() ? role.toString() : null;

          resultEl.textContent = "LLM thinking…";
          if (chatError) {
            chatError.textContent = "";
          }

          try {
            // const response = await fetch(
            //   "https://rag-saas-rag-630957115938.me-west1.run.app/chat",
            //   {
            //     method: "POST",
            //     headers: { "Content-Type": "application/json" },
            //     body: JSON.stringify({ workspace_id, question, role }),
            //   },
            // );
            const response = await fetch(
  "http://localhost:8000/chat",
  {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ workspace_id, question, role }),
  },
);


            if (!response.ok) {
              throw new Error("Request failed: " + response.status);
            }

            const data = await response.json();
            resultEl.innerHTML = "";

            const answerEl = document.createElement("p");
            answerEl.textContent = "Answer: " + (data.answer || "");
            resultEl.appendChild(answerEl);

            if (Array.isArray(data.sources) && data.sources.length) {
              const sourcesList = document.createElement("ul");
              data.sources.forEach((source) => {
                const item = document.createElement("li");
                const src = source.source || "unknown";
                const snippet =
                  (source.content && source.content.slice(0, 120)) || "";
                item.textContent = `${src} — ${snippet}`;
                sourcesList.appendChild(item);
              });
              resultEl.appendChild(sourcesList);
            }

            if (chatError) {
              chatError.textContent = "";
            }
          } catch (error) {
            if (chatError) {
              chatError.textContent = "Error: " + error.message;
            }
          }
        });
      }

      function setupIngest() {
        const ingestForm = document.getElementById("ingest-form");
        const ingestResult = document.getElementById("ingest-result");
        const ingestError = document.getElementById("ingest-error");

        if (!ingestForm || !ingestResult) return;

        ingestForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          ingestResult.textContent = "Uploading document…";
          if (ingestError) {
            ingestError.textContent = "";
          }

          const formData = new FormData(ingestForm);

          try {
            const response = await fetch(
              "https://rag-saas-ingest-630957115938.me-west1.run.app/ingest-file",
              {
                method: "POST",
                body: formData,
              },
            );

            if (!response.ok) {
              throw new Error("Request failed: " + response.status);
            }

            const data = await response.json();
            ingestResult.innerHTML = `
            Workspace: ${data.workspace_id || "n/a"}<br />
            Chunks: ${data.chunks_count ?? 0}<br />
            Embeddings: ${data.embeddings_count ?? 0}<br />
            Errors: ${(data.errors || []).join(", ") || "none"}
          `;
            if (ingestError) {
              ingestError.textContent = "";
            }
          } catch (error) {
            if (ingestError) {
              ingestError.textContent = "Error: " + error.message;
            }
          }
        });
      }
    })();
  </script>

</body>

</html>